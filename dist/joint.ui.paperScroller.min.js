/*! Rappid v2.4.0 - HTML5 Diagramming Framework - TRIAL VERSION

Copyright (c) 2015 client IO

 2019-03-27 


This Source Code Form is subject to the terms of the Rappid Trial License
, v. 2.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_v2.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


joint.ui.PaperScroller=joint.mvc.View.extend({className:"paper-scroller",options:{paper:void 0,padding:function(){var a=this.getClientSize(),b=Math.max(this.options.minVisiblePaperSize,1)||1,c={};return c.left=c.right=Math.max(a.width-b,0),c.top=c.bottom=Math.max(a.height-b,0),c},minVisiblePaperSize:50,autoResizePaper:!1,baseWidth:void 0,baseHeight:void 0,contentOptions:void 0,cursor:"default"},_padding:{left:0,top:0},init:function(){joint.util.bindAll(this,"startPanning","stopPanning","pan","onBackgroundEvent");var a=this.options.paper,b=a.scale();this._sx=b.sx,this._sy=b.sy,void 0===this.options.baseWidth&&(this.options.baseWidth=a.options.width),void 0===this.options.baseHeight&&(this.options.baseHeight=a.options.height),this.$background=$("<div/>").addClass("paper-scroller-background").css({width:a.options.width,height:a.options.height}).append(a.el).appendTo(this.el),this.listenTo(a,"scale",this.onScale).listenTo(a,"resize",this.onResize).listenTo(a,"beforeprint beforeexport",this.storeScrollPosition).listenTo(a,"afterprint afterexport",this.restoreScrollPosition),this.options.autoResizePaper&&(this.listenTo(a.model,"change add remove reset",this.adjustPaper),a.options.async&&this.listenTo(a,"render:done",this.adjustPaper)),this.delegateBackgroundEvents(),this.setCursor(this.options.cursor)},lock:function(){return this.$el.css("overflow","hidden"),this},unlock:function(){return this.$el.css("overflow","scroll"),this},setCursor:function(a){switch(a){case"grab":this.$el.css("cursor","");break;default:this.$el.css("cursor",a)}return this.$el.attr("data-cursor",a),this.options.cursor=a,this},delegateBackgroundEvents:function(a){function b(b,c){var d=a[c];return c.indexOf(" ")===-1&&(b[c]=joint.util.isFunction(d)?d:this.options.paper[d]),b}function c(a){this.delegate(a,{guarded:!1},this.onBackgroundEvent)}a||(a=joint.util.result(this.options.paper,"events"));var d=this.paperEvents=Object.keys(a||{}).reduce(b.bind(this),{});return Object.keys(d).forEach(c,this),this},onBackgroundEvent:function(a){if(this.$background.is(a.target)){var b=this.paperEvents[a.type];joint.util.isFunction(b)&&b.apply(this.options.paper,arguments)}},onResize:function(){this._center&&this.center(this._center.x,this._center.y)},onScale:function(a,b,c,d){this.adjustScale(a,b),this._sx=a,this._sy=b,(c||d)&&this.center(c,d)},storeScrollPosition:function(){this._scrollLeftBeforePrint=this.el.scrollLeft,this._scrollTopBeforePrint=this.el.scrollTop},restoreScrollPosition:function(){this.el.scrollLeft=this._scrollLeftBeforePrint,this.el.scrollTop=this._scrollTopBeforePrint,this._scrollLeftBeforePrint=null,this._scrollTopBeforePrint=null},beforePaperManipulation:function(){(joint.env.test("msie")||joint.env.test("msedge"))&&this.$el.css("visibility","hidden")},afterPaperManipulation:function(){(joint.env.test("msie")||joint.env.test("msedge"))&&this.$el.css("visibility","visible")},clientToLocalPoint:function(a,b){var c=this.options.paper.matrix();return a+=this.el.scrollLeft-this._padding.left-c.e,a/=c.a,b+=this.el.scrollTop-this._padding.top-c.f,b/=c.d,new g.Point(a,b)},localToBackgroundPoint:function(a,b){var c=new g.Point(a,b),d=this.options.paper.matrix(),e=this._padding;return V.transformPoint(c,d).offset(e.left,e.top)},adjustPaper:function(){var a=this.getClientSize();this._center=this.clientToLocalPoint(a.width/2,a.height/2);var b=joint.util.assign({gridWidth:this.options.baseWidth,gridHeight:this.options.baseHeight,allowNewOrigin:"negative"},this.options.contentOptions);return this.options.paper.fitToContent(this.transformContentOptions(b)),this},adjustScale:function(a,b){var c=this.options.paper.options,d=a/this._sx,e=b/this._sy;this.options.paper.setOrigin(c.origin.x*d,c.origin.y*e),this.options.paper.setDimensions(c.width*d,c.height*e)},transformContentOptions:function(a){var b=this._sx,c=this._sy;return a.gridWidth&&(a.gridWidth*=b),a.gridHeight&&(a.gridHeight*=c),a.minWidth&&(a.minWidth*=b),a.minHeight&&(a.minHeight*=c),joint.util.isObject(a.padding)?a.padding={left:(a.padding.left||0)*b,right:(a.padding.right||0)*b,top:(a.padding.top||0)*c,bottom:(a.padding.bottom||0)*c}:joint.util.isNumber(a.padding)&&(a.padding=a.padding*b),a},center:function(a,b,c){var d,e=this.options.paper.matrix(),f=-e.e,g=-e.f,h=f+this.options.paper.options.width,i=g+this.options.paper.options.height,j=joint.util.isNumber(a),k=joint.util.isNumber(b);if(j||k){d=c;var l=this.getVisibleArea().center();j?a*=e.a:a=l.x,k?b*=e.d:b=l.y}else d=a,a=(f+h)/2,b=(g+i)/2;var m=this.getClientSize(),n=this.getPadding(),o=m.width/2,p=m.height/2,q=o-n.left-a+f,r=o-n.right+a-h,s=p-n.top-b+g,t=p-n.bottom+b-i;return this.addPadding(Math.max(q,0),Math.max(r,0),Math.max(s,0),Math.max(t,0)),this.scroll(a,b,d),this},centerContent:function(a){return this.positionContent("center",a)},centerElement:function(a,b){return this.checkElement(a,"centerElement"),this.positionElement(a,"center",b)},positionContent:function(a,b){var c=this.options.paper.getContentArea();return this.positionRect(c,a,b)},positionElement:function(a,b,c){this.checkElement(a,"positionElement");var d=a.getBBox();return this.positionRect(d,b,c)},positionRect:function(a,b,c){var d;switch(b){case"center":return d=a.center(),this.positionPoint(d,"50%","50%",c);case"top":return d=a.topMiddle(),this.positionPoint(d,"50%",0,c);case"top-right":return d=a.topRight(),this.positionPoint(d,"100%",0,c);case"right":return d=a.rightMiddle(),this.positionPoint(d,"100%","50%",c);case"bottom-right":return d=a.bottomRight(),this.positionPoint(d,"100%","100%",c);case"bottom":return d=a.bottomMiddle(),this.positionPoint(d,"50%","100%",c);case"bottom-left":return d=a.bottomLeft(),this.positionPoint(d,0,"100%",c);case"left":return d=a.leftMiddle(),this.positionPoint(d,0,"50%",c);case"top-left":return d=a.topLeft(),this.positionPoint(d,0,0,c);default:throw new Error("Provided positionName ('"+b+"') was not recognized.")}},positionPoint:function(a,b,c,d){d=d||{};var e=joint.util.normalizeSides(d.padding),f=new g.Rect(this.getClientSize()),h=f.clone().moveAndExpand({x:e.left,y:e.top,width:-e.right-e.left,height:-e.top-e.bottom}),i=joint.util.isPercentage(b);b=parseFloat(b),i&&(b=b/100*Math.max(0,h.width)),b<0&&(b=h.width+b);var j=joint.util.isPercentage(c);c=parseFloat(c),j&&(c=c/100*Math.max(0,h.height)),c<0&&(c=h.height+c);var k=h.origin().offset(b,c),l=f.center(),m=l.difference(k),n=this.zoom(),o=m.scale(1/n,1/n),p=a.clone().offset(o);return this.center(p.x,p.y,d)},scroll:function(a,b,c){var d=this.options.paper.matrix(),e=this.getClientSize(),f={};if(joint.util.isNumber(a)){var g=e.width/2;f.scrollLeft=a-g+d.e+(this._padding.left||0)}if(joint.util.isNumber(b)){var h=e.height/2;f.scrollTop=b-h+d.f+(this._padding.top||0)}c&&c.animation?this.$el.animate(f,c.animation):this.$el.prop(f)},scrollToContent:function(a){var b=this.options.paper.getContentArea().center(),c=this._sx,d=this._sy;return b.x*=c,b.y*=d,this.scroll(b.x,b.y,a)},scrollToElement:function(a,b){this.checkElement(a,"scrollToElement");var c=a.getBBox().center(),d=this._sx,e=this._sy;return c.x*=d,c.y*=e,this.scroll(c.x,c.y,b)},addPadding:function(a,b,c,d){var e=this.getPadding(),f=this._padding={left:Math.round(e.left+(a||0)),top:Math.round(e.top+(c||0)),bottom:Math.round(e.bottom+(d||0)),right:Math.round(e.right+(b||0))};return this.$background.css({width:f.left+this.options.paper.options.width+f.right,height:f.top+this.options.paper.options.height+f.bottom}),this.options.paper.$el.css({left:f.left,top:f.top}),this},zoom:function(a,b){if(void 0===a)return this._sx;b=b||{};var c,d,e=this.getClientSize(),f=this.clientToLocalPoint(e.width/2,e.height/2),g=a,h=a;if(b.absolute||(g+=this._sx,h+=this._sy),b.grid&&(g=Math.round(g/b.grid)*b.grid,h=Math.round(h/b.grid)*b.grid),b.max&&(g=Math.min(b.max,g),h=Math.min(b.max,h)),b.min&&(g=Math.max(b.min,g),h=Math.max(b.min,h)),void 0===b.ox||void 0===b.oy)c=f.x,d=f.y;else{var i=g/this._sx,j=h/this._sy;c=b.ox-(b.ox-f.x)/i,d=b.oy-(b.oy-f.y)/j}return this.beforePaperManipulation(),this.options.paper.scale(g,h),this.center(c,d),this.afterPaperManipulation(),this},zoomToFit:function(a){a=a||{};var b=this.options.paper,c=joint.util.assign({},b.options.origin);return a.fittingBBox=a.fittingBBox||joint.util.assign({},new g.Point(c),{width:this.$el.width(),height:this.$el.height()}),this.beforePaperManipulation(),b.scaleContentToFit(a),b.setOrigin(c.x,c.y),this.adjustPaper().centerContent(),this.afterPaperManipulation(),this},transitionClassName:"transition-in-progress",transitionEventName:"transitionend.paper-scroller-transition",transitionToPoint:function(a,b,c){joint.util.isObject(a)&&(c=b,b=a.y,a=a.x),c||(c={});var d,e,f=this._sx,h=Math.max(c.scale||f,1e-6),i=this.getClientSize(),j=new g.Point(a,b),k=this.clientToLocalPoint(i.width/2,i.height/2);if(f===h){var l=k.difference(j).scale(f,f).round();d="translate("+l.x+"px,"+l.y+"px)"}else{var m=h/(f-h)*j.distance(k),n=k.clone().move(j,m),o=this.localToBackgroundPoint(n).round();d="scale("+h/f+")",e=o.x+"px "+o.y+"px"}return this.$el.addClass(this.transitionClassName),this.$background.off(this.transitionEventName).on(this.transitionEventName,function(a){var b=this.paperScroller;b.syncTransition(this.scale,{x:this.x,y:this.y});var c=this.onTransitionEnd;joint.util.isFunction(c)&&c.call(b,a)}.bind({paperScroller:this,scale:h,x:a,y:b,onTransitionEnd:c.onTransitionEnd})).css({transition:"transform",transitionDuration:c.duration||"1s",transitionDelay:c.delay,transitionTimingFunction:c.timingFunction,transformOrigin:e,transform:d}),this},syncTransition:function(a,b){return this.beforePaperManipulation(),this.options.paper.scale(a),this.removeTransition().center(b.x,b.y),this.afterPaperManipulation(),this},removeTransition:function(){return this.$el.removeClass(this.transitionClassName),this.$background.off(this.transitionEventName).css({transition:"",transitionDuration:"",transitionDelay:"",transitionTimingFunction:"",transform:"",transformOrigin:""}),this},transitionToRect:function(a,b){a=new g.Rect(a),b||(b={});var c=b.maxScale||1/0,d=b.minScale||Number.MIN_VALUE,e=b.scaleGrid||null,f=b.visibility||1,h=b.center?new g.Point(b.center):a.center(),i=this.getClientSize(),j=i.width*f,k=i.height*f,l=new g.Rect({x:h.x-j/2,y:h.y-k/2,width:j,height:k}),m=l.maxRectUniformScaleToFit(a,h);return m=Math.min(m,c),e&&(m=Math.floor(m/e)*e),m=Math.max(d,m),this.transitionToPoint(h,joint.util.defaults({scale:m},b))},startPanning:function(a){a=joint.util.normalizeEvent(a),this._clientX=a.clientX,this._clientY=a.clientY,this.$el.addClass("is-panning"),this.trigger("pan:start",a),$(document.body).on({"mousemove.panning touchmove.panning":this.pan,"mouseup.panning touchend.panning":this.stopPanning}),$(window).on("mouseup.panning",this.stopPanning)},pan:function(a){a=joint.util.normalizeEvent(a);var b=a.clientX-this._clientX,c=a.clientY-this._clientY;this.el.scrollTop-=c,this.el.scrollLeft-=b,this._clientX=a.clientX,this._clientY=a.clientY},stopPanning:function(a){$(document.body).off(".panning"),$(window).off(".panning"),this.$el.removeClass("is-panning"),this.trigger("pan:stop",a)},getClientSize:function(){return{width:this.el.clientWidth,height:this.el.clientHeight}},getPadding:function(){var a=this.options.padding;return joint.util.isFunction(a)&&(a=a.call(this)),joint.util.normalizeSides(a)},getVisibleArea:function(){var a=this.options.paper.matrix(),b=this.getClientSize(),c={x:this.el.scrollLeft||0,y:this.el.scrollTop||0,width:b.width,height:b.height},d=V.transformRect(c,a.inverse());return d.x-=(this._padding.left||0)/this._sx,d.y-=(this._padding.top||0)/this._sy,new g.Rect(d)},isElementVisible:function(a,b){this.checkElement(a,"isElementVisible"),b=b||{};var c=b.strict?"containsRect":"intersect";return!!this.getVisibleArea()[c](a.getBBox())},isPointVisible:function(a){return this.getVisibleArea().containsPoint(a)},checkElement:function(a,b){if(!(a&&a instanceof joint.dia.Element))throw new TypeError("ui.PaperScroller."+b+"() accepts instance of joint.dia.Element only")},onRemove:function(){this.stopPanning()}}),joint.env.addTest("msie",function(){var a=window.navigator.userAgent;return a.indexOf("MSIE")!==-1||a.indexOf("Trident")!==-1}),joint.env.addTest("msedge",function(){return/Edge\/\d+/.test(window.navigator.userAgent)});