/*! Rappid v2.4.0 - HTML5 Diagramming Framework - TRIAL VERSION

Copyright (c) 2015 client IO

 2019-03-27 


This Source Code Form is subject to the terms of the Rappid Trial License
, v. 2.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_v2.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


joint.ui.PathDrawer=joint.mvc.View.extend({tagName:"g",svgElement:!0,className:"path-drawer",events:{"mousedown .start-point":"onStartPointPointerDown",mousedown:"onPointerDown","touchstart .start-point":"onStartPointPointerDown",touchstart:"onPointerDown",dblclick:"onDoubleClick",contextmenu:"onContextMenu"},documentEvents:{mousemove:"onPointerMove",touchmove:"onPointerMove",mouseup:"onPointerUp",touchend:"onPointerUp",touchcancel:"onPointerUp"},options:{pathAttributes:{"class":null,fill:"#ffffff",stroke:"#000000","stroke-width":1,"pointer-events":"none"},startPointMarkup:'<circle r="5"/>',snapRadius:0},init:function(){var a=this.svgTarget=V(this.options.target);this.$document=$(a.node.ownerDocument),this.action="awaiting-input",this.render()},onRemove:function(){var a=this.pathNode;a&&V(a).remove(),this.clear()},clear:function(){var a=this.pathNode;a&&a.pathSegList.numberOfItems<=1&&V(a).remove(),this.svgStart.remove(),this.svgControl.remove(),this.pathNode=null,this.undelegateDocumentEvents(),this.action="awaiting-input",this.trigger("clear")},render:function(){var a=this.options;return this.svgPathTemplate=V("path").attr(a.pathAttributes),this.svgStart=V(a.startPointMarkup).addClass("start-point"),this.svgControl=V("path").addClass("control-path"),this.vel.append(V("rect",{x:0,y:0,width:"100%",height:"100%",fill:"transparent",stroke:"none"})),this.svgTarget.append(this.el),this},createPath:function(a,b){var c=this.svgPathTemplate.clone(),d=this.pathNode=c.node,e=this.svgStart.translate(a,b,{absolute:!0});this.trigger("path:create",d),this.addMoveSegment(a,b),this.vel.before(c),this.vel.append(e)},closePath:function(){var a=this.pathNode,b=a.pathSegList.getItem(0),c=a.pathSegList.getItem(a.pathSegList.numberOfItems-1);c.pathSegType==SVGPathSeg.PATHSEG_LINETO_ABS?a.pathSegList.replaceItem(a.createSVGPathSegClosePath(),a.pathSegList.numberOfItems-1):(c.x=b.x,c.y=b.y,a.pathSegList.appendItem(a.createSVGPathSegClosePath())),this.finishPath("path:close")},finishPath:function(a){var b=this.pathNode;b&&this.numberOfVisibleSegments()>0?(this.trigger("path:finish",b),this.trigger(a,b)):this.trigger("path:abort",b),this.clear()},numberOfVisibleSegments:function(){var a=this.pathNode,b=a.pathSegList.numberOfItems;return b-=1,a.pathSegList.getItem(a.pathSegList.numberOfItems-1).pathSegType==SVGPathSeg.PATHSEG_CLOSEPATH&&(b-=1),b},addMoveSegment:function(a,b){var c=this.pathNode,d=c.createSVGPathSegMovetoAbs(a,b);c.pathSegList.appendItem(d),this.trigger("path:segment:add",c),this.trigger("path:move-segment:add",c)},addLineSegment:function(a,b){var c=this.pathNode,d=c.createSVGPathSegLinetoAbs(a,b);c.pathSegList.appendItem(d),this.trigger("path:segment:add",c),this.trigger("path:line-segment:add",c)},addCurveSegment:function(a,b,c,d,e,f){var g=this.pathNode,h=g.createSVGPathSegCurvetoCubicAbs(a,b,c,d,e||a,f||b);g.pathSegList.appendItem(h),this.trigger("path:segment:add",g),this.trigger("path:curve-segment:add",g)},adjustLastSegment:function(a,b,c,d,e,f){var g=this.pathNode,h=this.options.snapRadius;if(h){var i=this.snapLastSegmentCoordinates(a,b,h);a=i.x,b=i.y}var j=g.pathSegList.getItem(g.pathSegList.numberOfItems-1);null!==a&&(j.x=a),null!==b&&(j.y=b),null!==c&&(j.x1=c),null!==d&&(j.y1=d),null!==e&&(j.x2=e),null!==f&&(j.y2=f),this.trigger("path:edit",g),this.trigger("path:last-segment:adjust",g)},snapLastSegmentCoordinates:function(a,b,c){for(var d=this.pathNode,e=!1,f=!1,h=a,i=b,j=d.pathSegList.numberOfItems-2;j>=0&&(!e||!f);j--){var k=d.pathSegList.getItem(j),l=k.x,m=k.y;!e&&Math.abs(l-a)<c&&(h=l,e=!0),!f&&Math.abs(m-b)<c&&(i=m,f=!0)}return new g.Point(h,i)},removeLastSegment:function(){var a=this.pathNode;a.pathSegList.removeItem(a.pathSegList.numberOfItems-1),this.trigger("path:edit",a),this.trigger("path:last-segment:remove",a)},findControlPoint:function(a,b){var c=this.pathNode,d=c.pathSegList.getItem(c.pathSegList.numberOfItems-1);return g.point(a,b).reflection(d)},replaceLastSegmentWithCurve:function(){var a=this.pathNode,b=a.pathSegList.getItem(a.pathSegList.numberOfItems-1),c=a.pathSegList.getItem(a.pathSegList.numberOfItems-2),d=a.createSVGPathSegCurvetoCubicAbs(b.x,b.y,c.x,c.y,b.x,b.y);a.pathSegList.replaceItem(d,a.pathSegList.numberOfItems-1),this.trigger("path:edit",a),this.trigger("path:last-segment:replace-with-curve",a)},adjustControlPath:function(a,b,c,d){var e=this.pathNode,f=this.svgControl.node;f.pathSegList.initialize(f.createSVGPathSegMovetoAbs(a,b)),f.pathSegList.appendItem(f.createSVGPathSegLinetoAbs(c,d)),this.vel.append(f),this.trigger("path:interact",e),this.trigger("path:control:adjust",e)},removeControlPath:function(){var a=this.pathNode,b=this.svgControl.node;b.pathSegList.clear(),this.vel.append(b),this.trigger("path:interact",a),this.trigger("path:control:remove",a)},onPointerDown:function(a){var b=joint.util.normalizeEvent(a);if(b.stopPropagation(),!(b.which>1)&&!(b.originalEvent.detail>1)&&this.el.parentNode){var c=this.vel.toLocalPoint(b.clientX,b.clientY);switch(this.action){case"awaiting-input":this.createPath(c.x,c.y),this.action="path-created",this.delegateDocumentEvents();break;case"adjusting-line-end":this.action="awaiting-line-end";break;case"adjusting-curve-end":this.action="awaiting-curve-control-2"}this._timeStamp=b.timeStamp}},MOVEMENT_DETECTION_THRESHOLD:150,onPointerMove:function(a){var b=joint.util.normalizeEvent(a);if(b.stopPropagation(),"awaiting-input"!=this.action){var c,d,e=this.vel.toLocalPoint(b.clientX,b.clientY),f=this._timeStamp;if(f)if(f&&b.timeStamp-f<this.MOVEMENT_DETECTION_THRESHOLD)switch(this.action){case"path-created":c=this.svgStart.translate(),this.adjustControlPath(c.tx,c.ty,e.x,e.y);break;case"awaiting-line-end":case"adjusting-curve-control-1":this.adjustLastSegment(e.x,e.y);break;case"awaiting-curve-control-2":this.adjustLastSegment(e.x,e.y,null,null,e.x,e.y)}else switch(this.action){case"path-created":this.action="adjusting-curve-control-1";break;case"awaiting-line-end":this.replaceLastSegmentWithCurve(),this.action="adjusting-curve-control-2";break;case"awaiting-curve-control-2":this.action="adjusting-curve-control-2";break;case"adjusting-curve-control-1":c=this.svgStart.translate(),this.adjustControlPath(c.tx,c.ty,e.x,e.y);break;case"adjusting-curve-control-2":d=this.findControlPoint(e.x,e.y),this.adjustLastSegment(null,null,null,null,d.x,d.y),this.adjustControlPath(d.x,d.y,e.x,e.y)}else switch(this.action){case"adjusting-line-end":this.adjustLastSegment(e.x,e.y);break;case"adjusting-curve-end":this.adjustLastSegment(e.x,e.y,null,null,e.x,e.y)}}},onPointerUp:function(a){this._timeStamp=null;var b=joint.util.normalizeEvent(a);if(b.stopPropagation(),!(b.which>1||b.originalEvent.detail>1)){var c=this.vel.toLocalPoint(b.clientX,b.clientY);switch(this.action){case"path-created":case"awaiting-line-end":this.addLineSegment(c.x,c.y),this.action="adjusting-line-end";break;case"awaiting-curve-control-2":this.removeControlPath(),this.addLineSegment(c.x,c.y),this.action="adjusting-line-end";break;case"adjusting-curve-control-1":case"adjusting-curve-control-2":this.addCurveSegment(c.x,c.y,c.x,c.y),this.action="adjusting-curve-end"}}},onStartPointPointerDown:function(a){var b=joint.util.normalizeEvent(a);b.stopPropagation(),b.which>1||b.originalEvent.detail>1||this.closePath()},onDoubleClick:function(a){var b=joint.util.normalizeEvent(a);b.preventDefault(),b.stopPropagation(),b.which>1||this.pathNode&&this.numberOfVisibleSegments()>0&&(this.removeLastSegment(),this.finishPath("path:stop"))},onContextMenu:function(a){var b=joint.util.normalizeEvent(a);b.preventDefault(),b.stopPropagation(),b.originalEvent.detail>1||this.pathNode&&this.numberOfVisibleSegments()>0&&(this.removeLastSegment(),this.finishPath("path:stop"))}});