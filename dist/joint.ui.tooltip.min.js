/*! Rappid v2.4.0 - HTML5 Diagramming Framework - TRIAL VERSION

Copyright (c) 2015 client IO

 2019-03-27 


This Source Code Form is subject to the terms of the Rappid Trial License
, v. 2.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_v2.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


joint.ui.Tooltip=joint.mvc.View.extend({className:"tooltip",options:{left:void 0,right:void 0,top:void 0,bottom:void 0,position:void 0,positionSelector:void 0,direction:"auto",minResizedWidth:100,padding:0,rootTarget:null,target:null,trigger:"hover",viewport:{selector:null,padding:0},dataAttributePrefix:"tooltip",template:'<div class="tooltip-arrow"/><div class="tooltip-arrow-mask"/><div class="tooltip-content"/>'},init:function(){this.eventNamespace=("."+this.className+this.cid).replace(/ /g,"_"),this.settings={},this.container=document.body;var a=this.options.trigger.split(" ");joint.util.bindAll(this,"render","hide","show","toggle","isVisible","position"),this.options.rootTarget?(this.$rootTarget=$(this.options.rootTarget),a.forEach(function(a){switch(a){case"click":this.$rootTarget.on("click"+this.eventNamespace,this.options.target,this.toggle);break;case"hover":this.$rootTarget.on("mouseover"+this.eventNamespace,this.options.target,this.render);break;case"focus":this.$rootTarget.on("focusin"+this.eventNamespace,this.options.target,this.render)}},this)):(this.$target=$(this.options.target),a.forEach(function(a){switch(a){case"click":this.$target.on("click"+this.eventNamespace,this.toggle);break;case"hover":this.$target.on("mouseover"+this.eventNamespace,this.render);break;case"focus":this.$target.on("focusin"+this.eventNamespace,this.render)}},this)),this.$el.append(this.options.template)},onRemove:function(){this.options.rootTarget?this.$rootTarget.off(this.eventNamespace):this.$target.off(this.eventNamespace)},hide:function(){var a=this.settings;a&&(this.unbindHideActions(a.currentTarget),this.$el.removeClass(a.className),this.$el.remove())},show:function(a){this.render(a||{target:this.options.target})},toggle:function(a){this.isVisible()?this.hide():this.show(a)},isVisible:function(){return document.body.contains(this.el)},render:function(a){var b=void 0!==a.x&&void 0!==a.y?a:null,c=$(a.target).closest(this.options.target)[0],d=this.settings=this.getTooltipSettings(c);d.currentTarget=c,this.bindHideActions(c);var e;e=b?{x:b.x,y:b.y,width:1,height:1}:joint.util.getElementBBox(c),this.$(".tooltip-content").html(d.content),this.$el.hide(),this.$el.removeClass("left right top bottom"),this.$el.addClass(d.className),$(this.container).append(this.$el);var f=this.$("img");f.length?f.on("load",function(){this.position(e),this.$el.addClass("rendered")}.bind(this)):(this.position(e),this.$el.addClass("rendered"))},getTooltipSettings:function(a){var b=this.loadDefinitionFromElementData(a);return this.evaluateOptions(a,b)},unbindHideActions:function(a){var b=this.eventNamespace+".remove";$(a).off(b),clearInterval(this.interval)},bindHideOnRemoveTarget:function(a){clearInterval(this.interval),this.interval=setInterval(function(){$.contains(document,a)||(clearInterval(this.interval),this.hide())}.bind(this),500)},bindHideActions:function(a){var b=this.settings,c=$(a),d=this.eventNamespace+".remove";this.bindHideOnRemoveTarget(a),this.options.trigger.split(" ").forEach(function(a){var e={hover:["mouseout","mousedown"],focus:["focusout"]},f=e[a]||[];b.hideTrigger&&(f=b.hideTrigger.split(" ")||[]),f.forEach(function(a){c.on(a+d,this.hide)},this)},this)},evaluateOptions:function(a,b){b=b||{};var c=joint.util.assign({},b,this.options);return joint.util.forIn(c,function(d,e){var f=joint.util.isFunction(d)?d(a):d;c[e]=void 0===f||null===f?b[e]:f}),this.normalizePosition(c),c},loadDefinitionFromElementData:function(a){if(!a)return{};var b=function(a){return"left"===a||"bottom"===a||"top"===a||"right"===a},c=this.getAllAttrs(a,"data-"+this.options.dataAttributePrefix),d={};return joint.util.forIn(c,function(a,c){""===c&&(c="content"),b(c)||(d[c]=a)}),d},getAllAttrs:function(a,b){for(var c=b||"",d=a.attributes,e={},f=0,g=d.length;f<g;f++){var h=d[f];if(h&&h.name.startsWith(c)){var i=joint.util.camelCase(h.name.slice(c.length));e[i]=h.value}}return e},normalizePosition:function(a){var b=a.left||a.right||a.top||a.bottom;!a.position&&b&&(a.left&&(a.position="left"),a.right&&(a.position="right"),a.top&&(a.position="top"),a.bottom&&(a.position="bottom")),!a.positionSelector&&b&&(a.positionSelector=b)},position:function(a){var b=this.settings;this.$el.show(),this.$el.css("width","auto");var c=joint.util.getElementBBox(this.container),d=this.getTooltipBBox(a,c);this.$el.css({left:d.x,top:d.y,width:d.width||"auto"});var e={};"left"===b.position||"right"===b.position?e.top=a.y+a.height/2-d.y:"top"===b.position||"bottom"===b.position?e.left=a.x+a.width/2-d.x:e.top=a.y+a.height/2-d.y,e.top-=c.y,e.left-=c.x,this.$(".tooltip-arrow, .tooltip-arrow-mask").removeAttr("style").css(e),b.direction&&"off"!==b.direction&&this.$el.addClass("auto"===b.direction?b.position||"left":b.direction)},getViewportViewBBox:function(){var a=this.settings,b=a.viewport.selector?$(a.currentTarget).closest(a.viewport.selector):"html",c=joint.util.getElementBBox(b);if(!a.viewport.selector){var d=$(window);c.width=d.width()+d.scrollLeft(),c.height=d.height()+d.scrollTop()}var e=a.viewport.padding||0;return c.x+=e,c.y+=e,c.width-=2*e,c.height-=2*e,c},basePositions:{left:function(a,b){var c={x:b.positionedBBox.x+b.positionedBBox.width+b.padding,y:b.targetBBox.y+b.targetBBox.height/2-b.tooltipBBox.height/2};if(a){var d=b.viewport.x+b.viewport.width-c.x;if(d>b.minWidth&&d<b.tooltipBBox.width+b.padding&&(c.width=d),d<b.minWidth)return this.settings.position="right",this.basePositions.right(!1,b)}return c},right:function(a,b){var c={x:b.positionedBBox.x-b.tooltipBBox.width-b.padding,y:b.targetBBox.y+b.targetBBox.height/2-b.tooltipBBox.height/2};if(a){var d=b.positionedBBox.x-b.padding-b.viewport.x;if(d>b.minWidth&&d<b.tooltipBBox.width+b.padding&&(c.width=d,c.x=b.viewport.x),d<b.minWidth)return this.settings.position="left",this.basePositions.left(!1,b)}return c},top:function(a,b){var c={x:b.targetBBox.x+b.targetBBox.width/2-b.tooltipBBox.width/2,y:b.positionedBBox.y+b.positionedBBox.height+b.padding};if(a){var d=b.viewport.y+b.viewport.height-(b.positionedBBox.y+b.positionedBBox.height+b.padding);if(d<b.tooltipBBox.height)return this.settings.position="bottom",this.basePositions.bottom(!1,b)}return c},bottom:function(a,b){var c={x:b.targetBBox.x+b.targetBBox.width/2-b.tooltipBBox.width/2,y:b.positionedBBox.y-b.tooltipBBox.height-b.padding};if(a){var d=b.positionedBBox.y-b.padding-b.viewport.y;if(d<b.tooltipBBox.height)return this.settings.position="top",this.basePositions.top(!1,b)}return c}},getTooltipBBox:function(a,b){var c=this.settings,d=$(c.positionSelector),e=d[0]?joint.util.getElementBBox(d[0]):a,f=this.measureTooltipElement(),g=this.getViewportViewBBox(),h=c.position||"left",i=c.padding,j=Math.min(c.minResizedWidth,f.width+i),k={padding:i,targetBBox:a,positionedBBox:e,tooltipBBox:f,viewport:g},l=this.basePositions[h].call(this,j>0,k);return l.x-=b.x,l.y-=b.y,l.y<g.y?l.y=g.y:l.y+f.height>g.y+g.height&&(l.y=g.y+g.height-f.height),l.x<g.x?l.x=g.x:l.x+f.width>g.x+g.width&&(l.x=g.x+g.width-f.width),l},measureTooltipElement:function(){var a=this.$el.clone().appendTo($("body")).css({left:-1e3,top:-500}),b={width:a.outerWidth(),height:a.outerHeight()};return a.remove(),b}});